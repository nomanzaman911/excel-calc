<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Calculator via Excel (OneDrive)</title>
  <script src="https://alcdn.msauth.net/browser/2.38.0/js/msal-browser.min.js"></script>
  <style>
    body { font-family: Arial; padding: 20px; background: #f3f3f3; }
    button { margin: 10px 5px; padding: 10px 15px; font-size: 16px; }
    input { padding: 8px; font-size: 16px; width: 100px; }
    pre { background: #fff; padding: 15px; border-radius: 6px; box-shadow: 0 0 5px rgba(0,0,0,0.1); }
  </style>
</head>
<body>

  <h2>üìä Excel Calculator (Powered by OneDrive)</h2>

  <button onclick="signIn()">üîê Sign In</button><br><br>

  <label>Input (A1): </label>
  <input type="number" id="a1Input" placeholder="Enter a number">
  <button onclick="updateCell()">üìù Update A1</button>
  <button onclick="readCells()">üìñ Read A1 & B1</button>

  <pre id="output">Status:\n</pre>

  <script>
    const msalConfig = {
      auth: {
        clientId: "1140a629-6ea1-41ec-9655-d5e1afab2408", // ‚úÖ Your App Client ID
        authority: "https://login.microsoftonline.com/common",
        redirectUri: window.location.href
      }
    };

    const fileId = "48d31887-5fad-4d73-a9f5-3c356e68a038"; // ‚úÖ Your Excel file ID
    const sheetName = "Sheet1";
    let accessToken = null;

    const msalInstance = new msal.PublicClientApplication(msalConfig);

    async function signIn() {
      try {
        const loginResponse = await msalInstance.loginPopup({
          scopes: ["User.Read", "Files.ReadWrite", "Sites.ReadWrite.All"]
        });
        const tokenResponse = await msalInstance.acquireTokenSilent({
          scopes: ["User.Read", "Files.ReadWrite", "Sites.ReadWrite.All"],
          account: loginResponse.account
        });
        accessToken = tokenResponse.accessToken;
        log("‚úÖ Signed in as: " + loginResponse.account.username);
      } catch (error) {
        log("‚ùå Sign-in failed: " + error.message);
      }
    }

    async function readCells() {
      if (!accessToken) return log("‚ö†Ô∏è Please sign in first.");

      const url = `https://graph.microsoft.com/v1.0/me/drive/items/${fileId}/workbook/worksheets('${sheetName}')/range(address='A1:B1')`;

      const res = await fetch(url, {
        headers: { Authorization: `Bearer ${accessToken}` }
      });

      const data = await res.json();
      log(`üìñ A1: ${data.values[0][0]} | B1 (calculated): ${data.values[0][1]}`);
    }

    async function updateCell() {
      if (!accessToken) return log("‚ö†Ô∏è Please sign in first.");

      const inputValue = document.getElementById("a1Input").value;
      if (!inputValue) return log("‚ùó Please enter a number.");

      const url = `https://graph.microsoft.com/v1.0/me/drive/items/${fileId}/workbook/worksheets('${sheetName}')/range(address='A1')`;

      const res = await fetch(url, {
        method: "PATCH",
        headers: {
          Authorization: `Bearer ${accessToken}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ values: [[Number(inputValue)]] })
      });

      if (res.ok) {
        log(`‚úÖ A1 updated to ${inputValue}. B1 will auto-calculate.`);
        await readCells(); // Auto-read after update
      } else {
        const err = await res.text();
        log("‚ùå Update failed:\n" + err);
      }
    }

    function log(msg) {
      const out = document.getElementById("output");
      out.textContent += msg + "\n";
      out.scrollTop = out.scrollHeight;
    }
  </script>

</body>
</html>
