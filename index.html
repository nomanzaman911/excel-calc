<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Excel Calculator via OneDrive (Path)</title>
  <script src="https://alcdn.msauth.net/browser/2.38.0/js/msal-browser.min.js"></script>
  <style>
    body { font-family: Arial; padding: 20px; background: #f0f0f0; }
    input, button { font-size: 16px; padding: 10px; margin: 5px; }
    pre { background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 0 5px rgba(0,0,0,0.1); }
  </style>
</head>
<body>

<h2>üìä Excel Calculator via OneDrive (Path-based)</h2>

<button onclick="signIn()">üîê Sign In</button>
<br><br>

<input type="number" id="a1Input" placeholder="Enter value for A1">
<button onclick="updateCell()">üìù Update A1</button>
<button onclick="readCells()">üìñ Read A1 & B1</button>

<pre id="output">Status:\n</pre>

<script>
  const msalConfig = {
    auth: {
      clientId: "1140a629-6ea1-41ec-9655-d5e1afab2408", // ‚úÖ Your app's client ID
      authority: "https://login.microsoftonline.com/common",
      redirectUri: window.location.href
    }
  };

  const msalInstance = new msal.PublicClientApplication(msalConfig);
  const filePath = "calculator.xlsx"; // ‚úÖ file in OneDrive root
  const sheetName = "Sheet1";         // ‚úÖ must match your worksheet name
  let accessToken = null;

  async function signIn() {
    try {
      const loginResponse = await msalInstance.loginPopup({
        scopes: ["User.Read", "Files.ReadWrite", "Sites.ReadWrite.All"]
      });

      const tokenResponse = await msalInstance.acquireTokenSilent({
        scopes: ["User.Read", "Files.ReadWrite", "Sites.ReadWrite.All"],
        account: loginResponse.account
      });

      accessToken = tokenResponse.accessToken;
      log("‚úÖ Signed in as: " + loginResponse.account.username);
    } catch (error) {
      log("‚ùå Sign-in failed: " + error.message);
    }
  }

  async function readCells() {
    if (!accessToken) return log("‚ö†Ô∏è Sign in first.");

    const url = `https://graph.microsoft.com/v1.0/me/drive/root:/${filePath}:/workbook/worksheets('${sheetName}')/range(address='A1:B1')`;

    const response = await fetch(url, {
      headers: { Authorization: `Bearer ${accessToken}` }
    });

    const data = await response.json();
    log(`üìñ A1: ${data.values?.[0]?.[0]} | B1: ${data.values?.[0]?.[1]}`);
  }

  async function updateCell() {
    if (!accessToken) return log("‚ö†Ô∏è Sign in first.");

    const value = document.getElementById("a1Input").value;
    if (!value) return log("‚ùó Please enter a number.");

    const url = `https://graph.microsoft.com/v1.0/me/drive/root:/${filePath}:/workbook/worksheets('${sheetName}')/range(address='A1')`;

    const response = await fetch(url, {
      method: "PATCH",
      headers: {
        Authorization: `Bearer ${accessToken}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ values: [[Number(value)]] })
    });

    if (response.ok) {
      log(`‚úÖ A1 updated to ${value}. Now reading B1...`);
      await readCells();
    } else {
      const err = await response.text();
      log("‚ùå Update failed:\n" + err);
    }
  }

  function log(msg) {
    const out = document.getElementById("output");
    out.textContent += msg + "\n";
    out.scrollTop = out.scrollHeight;
  }
</script>

</body>
</html>
